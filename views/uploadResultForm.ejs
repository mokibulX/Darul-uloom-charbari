<%- include("header") %>

<div class="container my-5">
  <h1 class="text-center text-primary mb-4">ðŸ“¤ Upload Student Results</h1>

  <!-- ================= Class Selection ================= -->
  <form action="/admin/result/upload-form" method="get" class="mb-4">
    <div class="mb-3">
      <label for="classId" class="form-label fw-bold">Select Class</label>
      <select id="classId" name="classId" class="form-select" onchange="this.form.submit()">
        <option value="">-- Select Class --</option>
        <% const safeSelectedClassId = typeof selectedClassId !== "undefined" ? selectedClassId : ""; %>
        <% classes.forEach(c => { %>
          <option value="<%= c._id %>" <%= c._id == safeSelectedClassId ? "selected" : "" %>><%= c.name %></option>
        <% }) %>
      </select>
    </div>
  </form>

  <% const safeStudents = Array.isArray(students) ? students : []; %>
  <% const safeKitabs = Array.isArray(kitabs) ? kitabs : []; %>

  <% if (safeStudents.length > 0 && safeKitabs.length > 0) { %>
    <form action="/admin/result/upload" method="post">
      <input type="hidden" name="classId" value="<%= safeSelectedClassId %>">

      <!-- Exam Month & Year -->
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="examMonth" class="form-label fw-bold">Exam Month</label>
          <input type="text" id="examMonth" name="examMonth" class="form-control" placeholder="e.g. June" required>
        </div>
        <div class="col-md-6">
          <label for="examYear" class="form-label fw-bold">Exam Year</label>
          <input type="number" id="examYear" name="examYear" class="form-control" placeholder="e.g. 2025" required>
        </div>
      </div>

      <hr>

      <!-- Excel Style Table -->
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <thead class="table-dark">
            <tr>
              <th>Student Name (App ID)</th>
              <% safeKitabs.forEach(kitab => { %>
                <th><%= kitab %></th>
              <% }) %>
            </tr>
          </thead>
          <tbody>
            <% safeStudents.forEach(student => { %>
              <tr>
                <td class="text-start ps-3"><%= student.name %> (<%= student.applicationId %>)</td>
                <% safeKitabs.forEach(kitab => { %>
                  <td>
                    <input type="number" name="studentResults[<%= student._id %>][marks][<%= kitab %>]" 
                           class="form-control text-center" placeholder="0" required>
                  </td>
                <% }) %>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <button type="submit" class="btn btn-success w-100 mt-3">Upload Results</button>
    </form>
  <% } %>
</div>

<%- include("footer") %>
